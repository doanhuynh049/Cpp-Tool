<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>tdisp.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.12 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>tdisp.h</h1><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment"> * Copyright (c) 1991-2006 TIBCO Software Inc.</font>
00003 <font class="comment"> * All rights reserved.</font>
00004 <font class="comment"> * For more information, please contact:</font>
00005 <font class="comment"> * TIBCO Software Inc., Palo Alto, California, USA</font>
00006 <font class="comment"> *</font>
00007 <font class="comment"> * $Id: //dev/packages/tpsi/cpsi/dev/68/src/rtworks/tdisp.h#1 $</font>
00008 <font class="comment"> */</font>
00009 
00010 <font class="preprocessor">#ifndef _T_DISPATCHER_HH</font>
00011 <font class="preprocessor"></font><font class="preprocessor">#define _T_DISPATCHER_HH</font>
00012 <font class="preprocessor"></font>
00013 <font class="preprocessor">#include &lt;rtworks/ipc.h&gt;</font>
00014 <font class="preprocessor">#include &lt;rtworks/tex.h&gt;</font>
00015 <font class="preprocessor">#include &lt;rtworks/tevent.h&gt;</font>
00016 <font class="preprocessor">#include &lt;rtworks/tsrv.h&gt;</font>
00017 <font class="preprocessor">#include &lt;rtworks/tmsg.h&gt;</font>
00018 <font class="keyword">namespace </font>SmartSockets {
00019 
<a name="l00026"></a><a class="code" href="classSmartSockets_1_1TipcDispatcherException.html">00026</a>   <font class="keyword">class </font>T_IPCX_API TipcDispatcherException : <font class="keyword">public</font> TipcException {
00027 
00028   <font class="keyword">public</font>:
<a name="l00032"></a><a class="code" href="classSmartSockets_1_1TipcDispatcherException.html#a0">00032</a>     TipcDispatcherException ()
00033     {
00034     }
00035 
00036     TipcDispatcherException (int4 errorNum)
00037     :TipcException(errorNum)
00038     {
00039     }
00040 
<a name="l00044"></a><a class="code" href="classSmartSockets_1_1TipcDispatcherException.html#a2">00044</a>     <font class="keyword">virtual</font> ~TipcDispatcherException () <font class="keywordflow">throw</font>()
00045     {
00046     }
00047   };
00048 
00049   <font class="keyword">class </font>T_IPCX_API TipcDispatcher;
00050   <font class="keyword">class </font>T_IPCX_API TipcEvent;
00051 
00052 
<a name="l00056"></a><a class="code" href="classSmartSockets_1_1TipcDispatcherTraverser.html">00056</a>   <font class="keyword">class </font>T_IPCX_API TipcDispatcherTraverser {
00057   <font class="keyword">public</font>:
00058 
00065     <font class="keyword">typedef</font> bool (TipcDispatcherTraverser::* Handler)
00066     (
00067     TipcDispatcher&amp; disp,
00068     <font class="keyword">const</font> TipcEvent* event
00069     ) ;
00070 
00071 
00072 
00076     TipcDispatcherTraverser();
00077 
00082     <font class="keywordtype">void</font> setHandler(Handler cbMethod);
00083 
00087     Handler getHandler();
00088 
00089 
00093     <font class="keyword">virtual</font> ~TipcDispatcherTraverser() <font class="keywordflow">throw</font>();
00094 
00095 
00102     <font class="keyword">virtual</font> <font class="keywordtype">bool</font> onTraverse (TipcDispatcher&amp; disp, <font class="keyword">const</font> TipcEvent* event);
00103 
00104     <font class="keyword">static</font>  T_PTR T_ENTRY traverseFuncDelegator
00105     (
00106     T_IPC_DISPATCHER disp,
00107     T_IPC_EVENT  event,
00108     T_PTR arg
00109     );
00110 
00111   <font class="keyword">private</font>:
00112 
00113     Handler _cbMethod;
00114 
00115   };
00116 
<a name="l00161"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html">00161</a>   <font class="keyword">class </font>T_IPCX_API TipcDispatcher {
00162   <font class="keyword">private</font>:
00163     <font class="keywordtype">bool</font> _isDetached;
00164     <font class="keywordtype">bool</font> _destroyFlag;
00165     T_IPC_DISPATCHER _dispatcher;
00166 
00167   <font class="keyword">public</font>:
<a name="l00177"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a0">00177</a>     TipcDispatcher (T_IPC_DISPATCHER dispatcher,
00178                     <font class="keywordtype">bool</font> destroyFlag = <font class="keyword">false</font>,
00179                     <font class="keywordtype">bool</font> isDetached = <font class="keyword">false</font>)
00180     <font class="keywordflow">throw</font> (TipcException)
00181     :_dispatcher (dispatcher),
00182     _isDetached(isDetached),
00183     _destroyFlag(destroyFlag)
00184     {
00185       <font class="keywordflow">if</font> (_dispatcher == NULL) {
00186         <font class="keywordflow">throw</font> TipcDispatcherException(T_ERR_NULL_PTR);
00187       }
00188     }
00189 
<a name="l00199"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a1">00199</a>     TipcDispatcher (<font class="keywordtype">bool</font> isDetached = <font class="keyword">false</font>)
00200     <font class="keywordflow">throw</font> (TipcException)
00201     : _isDetached(isDetached)
00202     , _destroyFlag(<font class="keyword">true</font>)
00203     {
00204       <font class="keywordflow">if</font> (_isDetached) {
00205         <font class="keywordflow">if</font> (!TipcThreadEnabled()) {
00206           <font class="keywordflow">throw</font> (TipcDispatcherException(T_ERR_VAL_INVALID));
00207         }
00208         _dispatcher = TipcDispatcherCreateDetached();
00209         <font class="keywordflow">if</font> (NULL == _dispatcher) {
00210           <font class="keywordflow">throw</font> TipcDispatcherException();
00211         }
00212       }
00213       <font class="keywordflow">else</font> {
00214         _dispatcher = TipcDispatcherCreate();
00215         <font class="keywordflow">if</font> (NULL == _dispatcher) {
00216           <font class="keywordflow">throw</font> TipcDispatcherException();
00217         }
00218       }
00219     }
00220 
<a name="l00225"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a2">00225</a>     <font class="keyword">virtual</font> ~TipcDispatcher () <font class="keywordflow">throw</font> ()
00226     {
00227       <font class="keywordflow">if</font> (_destroyFlag) {
00228         TipcDispatcherDestroy(_dispatcher);
00229       }
00230     }
00231 
<a name="l00235"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a3">00235</a>     operator T_IPC_DISPATCHER ()
00236     <font class="keyword">const</font> <font class="keywordflow">throw</font> ()
00237     {
00238       <font class="keywordflow">return</font> _dispatcher;
00239     }
00240 
00246     <font class="keywordtype">bool</font> dispatch(real8 timeout = T_TIMEOUT_FOREVER)
00247     <font class="keywordflow">throw</font> (TipcException);
00248 
00255     <font class="keywordtype">bool</font> mainLoop(real8 timeout = T_TIMEOUT_FOREVER)
00256     <font class="keywordflow">throw</font> (TipcException);
00257 
00258 
00266     <font class="keywordtype">void</font> eventTraverse
00267     (
00268     TipcDispatcherTraverser* travObj
00269     ) <font class="keywordflow">throw</font> (TipcException);
00270 
00271 
00288     MessageEvent* createMsgTypeEvent
<a name="l00289"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a7">00289</a>     (
00290     <font class="keyword">const</font> TipcSrv&amp; srv,
00291     <font class="keyword">const</font> TipcMt&amp; mt,
00292     MessageEventHandler* handlerObj
00293     ) <font class="keywordflow">throw</font> (TipcException)
00294     {
00295       MessageEventHandler::Handler hndlrMethod =
00296       &amp;MessageEventHandler::onMessage;
00297       MessageEvent* event = <font class="keyword">new</font> MessageEvent(handlerObj,hndlrMethod);
00298 
00299       <font class="keywordflow">if</font> (!event)
00300         <font class="keywordflow">throw</font> TipcDispatcherException(T_ERR_NOMEM);
00301 
00302       T_IPC_EVENT cEvent = TipcEventCreateMsgType(_dispatcher,
00303                                                   (T_IPC_SRV) srv,
00304                                                   (T_IPC_MT) mt,
00305                                                   &amp;TipcDispatcher::messageEventDelegator,
00306                                                   event);
00307       <font class="keywordflow">if</font> (!cEvent)
00308         <font class="keywordflow">throw</font> TipcDispatcherException();
00309 
00310       event-&gt;setEvent(cEvent);
00311 
00312       <font class="keywordflow">return</font> event;
00313 
00314     }
00315 
00316 <font class="preprocessor">#if 0</font>
00317 <font class="preprocessor"></font>
00332     MessageEvent* createMsgDefaultEvent
00333     (
00334     <font class="keyword">const</font> TipcSrv&amp; srv,
00335     MessageEventHandler* handlerObj,
00336     MessageEventHandler::Handler handlerMethod = &amp;MessageEventHandler::onMessage
00337     ) <font class="keywordflow">throw</font> (TipcException)
00338     {
00339       MessageEvent* event = <font class="keyword">new</font> MessageEvent(handlerObj,handlerMethod);
00340 
00341       <font class="keywordflow">if</font> (!event)
00342         <font class="keywordflow">throw</font> TipcDispatcherException(T_ERR_NOMEM);
00343 
00344       T_IPC_EVENT cEvent = TipcEventCreateMsgDefault(_dispatcher,
00345                                                      (T_IPC_SRV) srv,
00346                                                      messageEventDelegator,
00347                                                      event);
00348       <font class="keywordflow">if</font> (!cEvent)
00349         <font class="keywordflow">throw</font> TipcDispatcherException();
00350 
00351       event-&gt;setEvent(cEvent);
00352 
00353       <font class="keywordflow">return</font> event;
00354 
00355     }
00356 <font class="preprocessor">#endif</font>
00357 <font class="preprocessor"></font>
00371     MessageEvent* createMsgSubjEvent
<a name="l00372"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a8">00372</a>     (
00373     <font class="keyword">const</font> TipcSrv&amp; srv,
00374     <font class="keyword">const</font> <font class="keywordtype">char</font>* subject,
00375     MessageEventHandler* handlerObj
00376     ) <font class="keywordflow">throw</font> (TipcException)
00377     {
00378       MessageEventHandler::Handler handlerMethod =
00379       &amp;MessageEventHandler::onMessage;
00380       MessageEvent* event = <font class="keyword">new</font> MessageEvent(handlerObj,handlerMethod);
00381 
00382       <font class="keywordflow">if</font> (!event)
00383         <font class="keywordflow">throw</font> TipcDispatcherException(T_ERR_NOMEM);
00384 
00385       T_IPC_EVENT cEvent = TipcEventCreateMsg(_dispatcher,
00386                                               (T_IPC_SRV) srv,
00387                                               const_cast &lt;char*&gt;(subject),
00388                                               messageEventDelegator,
00389                                               event);
00390       <font class="keywordflow">if</font> (!cEvent)
00391         <font class="keywordflow">throw</font> TipcDispatcherException();
00392 
00393       event-&gt;setEvent(cEvent);
00394 
00395       <font class="keywordflow">return</font> event;
00396 
00397     }
00398 
00399 
00410     TimerEvent* createTimerEvent
<a name="l00411"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a9">00411</a>     (
00412     real8 interval,
00413     TimerEventHandler* handlerObj
00414     ) <font class="keywordflow">throw</font> (TipcException)
00415     {
00416       TimerEventHandler::Handler handlerMethod = &amp;TimerEventHandler::onTimer;
00417       TimerEvent* event = <font class="keyword">new</font> TimerEvent(handlerObj,handlerMethod);
00418 
00419       <font class="keywordflow">if</font> (!event)
00420         <font class="keywordflow">throw</font> TipcDispatcherException(T_ERR_NOMEM);
00421 
00422       T_IPC_EVENT cEvent = TipcEventCreateTimer(_dispatcher,
00423                                                 interval,
00424                                                 timerEventDelegator,
00425                                                 event);
00426       <font class="keywordflow">if</font> (!cEvent)
00427         <font class="keywordflow">throw</font> TipcDispatcherException();
00428 
00429       event-&gt;setEvent(cEvent);
00430 
00431       <font class="keywordflow">return</font> event;
00432     }
00433 
00450     ConnEvent* createConnEvent
<a name="l00451"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a10">00451</a>     (
00452     <font class="keyword">const</font> TipcConn&amp; connection,
00453     T_IO_CHECK_MODE checkMode,
00454     ConnEventHandler* handlerObj
00455     ) <font class="keywordflow">throw</font> (TipcException)
00456     {
00457       ConnEventHandler::Handler handlerMethod =
00458       &amp;ConnEventHandler::onConnEvent;
00459       ConnEvent* event = <font class="keyword">new</font> ConnEvent(handlerObj,handlerMethod);
00460 
00461       <font class="keywordflow">if</font> (!event)
00462         <font class="keywordflow">throw</font> TipcDispatcherException(T_ERR_NOMEM);
00463 
00464       T_IPC_EVENT cEvent = TipcEventCreateConn(_dispatcher,
00465                                                (T_IPC_CONN)connection,
00466                                                checkMode,
00467                                                &amp;TipcDispatcher::connEventDelegator,
00468                                                event);
00469       <font class="keywordflow">if</font> (!cEvent)
00470         <font class="keywordflow">throw</font> TipcDispatcherException();
00471 
00472       event-&gt;setEvent(cEvent);
00473 
00474       <font class="keywordflow">return</font> event;
00475     }
00476 
00493     SocketEvent* createSocketEvent
<a name="l00494"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a11">00494</a>     (
00495     sock socketFd,
00496     T_IO_CHECK_MODE checkMode,
00497     SocketEventHandler* handlerObj
00498     ) <font class="keywordflow">throw</font> (TipcException)
00499     {
00500       SocketEventHandler::Handler handlerMethod =
00501       &amp;SocketEventHandler::onSocket;
00502       SocketEvent* event = <font class="keyword">new</font> SocketEvent(handlerObj,handlerMethod);
00503 
00504       <font class="keywordflow">if</font> (!event)
00505         <font class="keywordflow">throw</font> TipcDispatcherException(T_ERR_NOMEM);
00506 
00507       T_IPC_EVENT cEvent = TipcEventCreateSocket(_dispatcher,
00508                                                  socketFd,
00509                                                  checkMode,
00510                                                  &amp;TipcDispatcher::socketEventDelegator,
00511                                                  event);
00512       <font class="keywordflow">if</font> (!cEvent)
00513         <font class="keywordflow">throw</font> TipcDispatcherException();
00514 
00515       event-&gt;setEvent(cEvent);
00516 
00517       <font class="keywordflow">return</font> event;
00518     }
00519 
00530     UserEvent* createUserEvent
<a name="l00531"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a12">00531</a>     (
00532     <font class="keywordtype">void</font>* data,
00533     UserEventHandler* handlerObj
00534     ) <font class="keywordflow">throw</font> (TipcException)
00535     {
00536       UserEventHandler::Handler handlerMethod= &amp;UserEventHandler::onUserEvent;
00537       UserEvent* event = <font class="keyword">new</font> UserEvent(handlerObj,handlerMethod);
00538 
00539       <font class="keywordflow">if</font> (!event)
00540         <font class="keywordflow">throw</font> TipcDispatcherException(T_ERR_NOMEM);
00541 
00542       T_IPC_EVENT cEvent = TipcEventCreate(_dispatcher,
00543                                            data,
00544                                            &amp;TipcDispatcher::userEventDelegator,
00545                                            event);
00546       <font class="keywordflow">if</font> (!cEvent)
00547         <font class="keywordflow">throw</font> TipcDispatcherException();
00548 
00549       event-&gt;setEvent(cEvent);
00550 
00551       <font class="keywordflow">return</font> event;
00552     }
00553 
00554 
<a name="l00558"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a13">00558</a>     <font class="keywordtype">void</font> destroyEvent (TipcEvent* event)
00559     <font class="keywordflow">throw</font> (TipcException)
00560     {
00561       <font class="keywordflow">try</font> {
00562         event-&gt;destroy();
00563 
00564         event = NULL;
00565       }
00566       <font class="keywordflow">catch</font> (Exception&amp; e) {
00567         <font class="keywordflow">throw</font> TipcDispatcherException(e.getErrNum());
00568       }
00569 
00570     }
00571 
00572 
<a name="l00584"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a14">00584</a>     <font class="keywordtype">void</font> addInboundConnection(<font class="keyword">const</font> TipcSrv&amp; srv)
00585     <font class="keywordflow">throw</font> (TipcException)
00586     {
00587       T_IPC_DISPATCHER disp;
00588       <font class="keywordflow">if</font> (!TipcSrvConnGetDispatcher((T_IPC_SRV)srv,&amp;disp)) {
00589         <font class="keywordflow">throw</font> TipcDispatcherException();
00590       }
00591       <font class="keywordflow">if</font> (disp != NULL) {
00592         <font class="keywordflow">throw</font>(TipcDispatcherException(T_ERR_ALREADY_EXISTS));
00593       }
00594       <font class="keywordflow">if</font> (!TipcSrvConnSetDispatcher((T_IPC_SRV)srv,_dispatcher)) {
00595         <font class="keywordflow">throw</font> TipcDispatcherException();
00596       }
00597     }
00598 
<a name="l00606"></a><a class="code" href="classSmartSockets_1_1TipcDispatcher.html#a15">00606</a>     <font class="keywordtype">void</font> removeInboundConnection(<font class="keyword">const</font> TipcSrv&amp; srv)
00607     <font class="keywordflow">throw</font> (TipcException)
00608     {
00609       T_IPC_DISPATCHER disp;
00610       <font class="keywordflow">if</font> (!TipcSrvConnGetDispatcher((T_IPC_SRV)srv,&amp;disp)) {
00611         <font class="keywordflow">if</font> (disp != _dispatcher) {
00612           <font class="keywordflow">throw</font>(TipcDispatcherException(T_ERR_DOESNT_EXIST));
00613         }
00614       }
00615       <font class="keywordflow">if</font> (!TipcSrvConnSetDispatcher((T_IPC_SRV)srv,NULL)) {
00616         <font class="keywordflow">throw</font> TipcDispatcherException();
00617       }
00618     }
00619 
00620   <font class="keyword">private</font>:
00621 
00622     <font class="keyword">static</font> <font class="keywordtype">void</font> T_ENTRY messageEventDelegator (T_IPC_EVENT eventParam,
00623                                                T_IPC_EVENT_DATA eventData,
00624                                                T_PTR arg)
00625     {
00626       MessageEvent* event = (MessageEvent*) arg;
00627       TipcMsg msg(eventData-&gt;msg);
00628 
00629       ((event-&gt;_handlerObj)-&gt;*(event-&gt;_handlerMethod)) (*event,msg);
00630 
00631     }
00632 
00633 
00634     <font class="keyword">static</font> <font class="keywordtype">void</font> T_ENTRY socketEventDelegator (T_IPC_EVENT eventParam,
00635                                               T_IPC_EVENT_DATA eventData,
00636                                               T_PTR arg)
00637     {
00638       SocketEvent* event = (SocketEvent*) arg;
00639       sock socketFd = eventData-&gt;socket;
00640       T_IO_CHECK_MODE checkMode = eventData-&gt;check_mode;
00641 
00642       ((event-&gt;_handlerObj)-&gt;*(event-&gt;_handlerMethod)) (*event,
00643                                                         socketFd,
00644                                                         checkMode);
00645 
00646     }
00647 
00648 
00649     <font class="keyword">static</font> <font class="keywordtype">void</font> T_ENTRY userEventDelegator (T_IPC_EVENT eventParam,
00650                                             T_IPC_EVENT_DATA eventData,
00651                                             T_PTR arg)
00652     {
00653       UserEvent* event = (UserEvent*) arg;
00654       <font class="keywordtype">void</font>* data = eventData-&gt;data;
00655 
00656       ((event-&gt;_handlerObj)-&gt;*(event-&gt;_handlerMethod)) (*event,
00657                                                         data);
00658 
00659     }
00660 
00661 
00662 
00663     <font class="keyword">static</font> <font class="keywordtype">void</font> T_ENTRY connEventDelegator (T_IPC_EVENT eventParam,
00664                                             T_IPC_EVENT_DATA eventData,
00665                                             T_PTR arg)
00666     {
00667       ConnEvent* event = (ConnEvent*) arg;
00668       TipcConn conn (eventData-&gt;conn,<font class="keyword">false</font>);
00669       T_IO_CHECK_MODE checkMode = eventData-&gt;check_mode;
00670 
00671       ((event-&gt;_handlerObj)-&gt;*(event-&gt;_handlerMethod)) (*event,
00672                                                         conn,
00673                                                         checkMode);
00674 
00675     }
00676 
00677 
00678 
00679     <font class="keyword">static</font> <font class="keywordtype">void</font> T_ENTRY timerEventDelegator (T_IPC_EVENT eventParam,
00680                                              T_IPC_EVENT_DATA eventData,
00681                                              T_PTR arg)
00682     {
00683       TimerEvent* event = (TimerEvent*) arg;
00684       real8 interval = eventData-&gt;interval;
00685 
00686       ((event-&gt;_handlerObj)-&gt;*(event-&gt;_handlerMethod)) (*event,
00687                                                         interval);
00688 
00689     }
00690 
00691   };
00692 } <font class="comment">// namespace SmartSockets</font>
00693 
00694 
00695 <font class="preprocessor">#endif //_T_DISPATCHER_HH</font>
00696 <font class="preprocessor"></font>
</pre></div><hr><address><small>Generated on Mon Apr 13 16:28:25 2009 by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.12 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
